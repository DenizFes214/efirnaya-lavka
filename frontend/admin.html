<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üîÆ –ê–ª—Ç–∞—Ä—å –ß–∞—Ä–æ–¥–µ–π–∫–∏ ‚Äî –ê–¥–º–∏–Ω</title>
  <link rel="stylesheet" href="/static/css/tma-styles.css">
  <style>
    /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ */
    .admin-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem;
    }
    
    .admin-tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 2rem;
      overflow-x: auto;
      border-bottom: 2px solid var(--magical-gold);
      padding-bottom: 0.5rem;
    }
    
    .admin-tab {
      padding: 0.8rem 1.5rem;
      background: var(--magical-brown);
      color: var(--magical-cream);
      border: 2px solid var(--magical-light-green);
      border-radius: 10px;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.3s ease;
    }
    
    .admin-tab.active {
      background: var(--magical-gold);
      color: var(--magical-dark);
      border-color: var(--magical-gold);
    }
    
    .admin-section {
      display: none;
    }
    
    .admin-section.active {
      display: block;
    }
    
    .admin-form {
      background: var(--gradient-forest);
      border: 2px solid var(--magical-light-green);
      border-radius: 15px;
      padding: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .form-row {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    
    .form-group {
      flex: 1;
      min-width: 200px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--magical-gold);
      font-weight: bold;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 0.8rem;
      border: 2px solid var(--magical-light-green);
      border-radius: 10px;
      background: rgba(245, 241, 232, 0.9);
      color: var(--magical-dark);
      font-family: inherit;
    }
    
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      border-color: var(--magical-gold);
      box-shadow: 0 0 10px var(--magical-glow);
      outline: none;
    }
    
    .admin-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1rem;
    }
    
    .admin-card {
      background: var(--gradient-forest);
      border: 2px solid var(--magical-light-green);
      border-radius: 15px;
      padding: 1rem;
      transition: all 0.3s ease;
    }
    
    .admin-card:hover {
      border-color: var(--magical-gold);
      box-shadow: 0 5px 15px var(--magical-shadow);
    }
    
    .admin-card-image {
      width: 100%;
      height: 150px;
      object-fit: cover;
      border-radius: 10px;
      margin-bottom: 1rem;
    }
    
    .admin-card-title {
      color: var(--magical-gold);
      margin-bottom: 0.5rem;
    }
    
    .admin-card-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    
    .btn-admin {
      padding: 0.5rem 1rem;
      border: 1px solid var(--magical-gold);
      border-radius: 8px;
      background: var(--magical-gold);
      color: var(--magical-dark);
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s ease;
    }
    
    .btn-admin:hover {
      background: transparent;
      color: var(--magical-gold);
    }
    
    .btn-admin.btn-danger {
      border-color: #d32f2f;
      background: #d32f2f;
      color: white;
    }
    
    .btn-admin.btn-danger:hover {
      background: transparent;
      color: #d32f2f;
    }
  </style>
</head>
<body>
  
  <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ -->
  <header class="shop-header">
    <h1>üîÆ –ê–ª—Ç–∞—Ä—å –ß–∞—Ä–æ–¥–µ–π–∫–∏</h1>
    <p>–ú–∞–≥–∏—á–µ—Å–∫–∞—è –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ª–∞–≤–∫–æ–π</p>
    <a href="/" class="btn btn-secondary">üåø –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –ª–∞–≤–∫—É</a>
  </header>
<div class="wrap">
  <div class="tabs">
    <div class="tab active" data-tab="products">–¢–æ–≤–∞—Ä—ã</div>
    <div class="tab" data-tab="categories">–†–∞–∑–¥–µ–ª—ã</div>
    <div class="tab" data-tab="reviews">–û—Ç–∑—ã–≤—ã</div>
    <div class="tab" data-tab="promotions">–ê–∫—Ü–∏–∏</div>
    <div class="tab" data-tab="orders">–ó–∞–∫–∞–∑—ã</div>
  </div>

  <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞–º–∏ -->
  <div id="productsTab" class="tab-content">
    <div class="row">
      <label>–†–∞–∑–¥–µ–ª</label>
      <select id="category"></select>
      <label>–¢–æ–≤–∞—Ä</label>
      <select id="product"></select>
      <button onclick="openCreateProduct()">–°–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä</button>
      <button class="muted" onclick="openEditProduct()">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä</button>
      <button class="muted" onclick="openDeleteProduct()">–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
    </div>

    <div id="productForm" class="card" style="display:none"></div>
  </div>

  <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞–º–∏ -->
  <div id="categoriesTab" class="tab-content" style="display:none">
    <div class="row">
      <button onclick="openCreateCategory()">–°–æ–∑–¥–∞—Ç—å —Ä–∞–∑–¥–µ–ª</button>
      <button class="muted" onclick="openEditCategory()">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–∑–¥–µ–ª</button>
      <button class="muted" onclick="openDeleteCategory()">–£–¥–∞–ª–∏—Ç—å —Ä–∞–∑–¥–µ–ª</button>
    </div>

    <div id="categoryForm" class="card" style="display:none"></div>

    <div class="card">
      <h3>–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ä–∞–∑–¥–µ–ª—ã</h3>
      <div id="categoriesList"></div>
    </div>
  </div>

  <!-- –ú–æ–¥–µ—Ä–∞—Ü–∏—è –æ—Ç–∑—ã–≤–æ–≤ -->
  <div id="reviewsTab" class="tab-content" style="display:none">
    <div class="row">
      <label>–†–∞–∑–¥–µ–ª</label>
      <select id="reviewCategory"></select>
      <label>–¢–æ–≤–∞—Ä</label>
      <select id="reviewProduct"></select>
      <button onclick="loadReviews()">–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ—Ç–∑—ã–≤—ã</button>
    </div>

    <div class="card">
      <h3>–û—Ç–∑—ã–≤—ã –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏</h3>
      <div id="reviewsList"></div>
    </div>
  </div>

  <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–∫—Ü–∏—è–º–∏ -->
  <div id="promotionsTab" class="tab-content" style="display:none">
    <div class="row">
      <button onclick="openCreatePromotion()">–°–æ–∑–¥–∞—Ç—å –∞–∫—Ü–∏—é</button>
    </div>

    <div id="promotionForm" class="card" style="display:none"></div>

    <div class="card">
      <h3>–ê–∫—Ç–∏–≤–Ω—ã–µ –∞–∫—Ü–∏–∏</h3>
      <div id="promotionsList"></div>
    </div>
  </div>

  <!-- –ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–∫–∞–∑–æ–≤ -->
  <div id="ordersTab" class="tab-content" style="display:none">
    <div class="row">
      <label>–°:</label>
      <input type="date" id="startDate">
      <label>–ü–æ:</label>
      <input type="date" id="endDate">
      <label>–°—Ç–∞—Ç—É—Å:</label>
      <select id="orderStatus">
        <option value="">–í—Å–µ</option>
        <option value="new">–ù–æ–≤—ã–µ</option>
        <option value="processed">–í –æ–±—Ä–∞–±–æ—Ç–∫–µ</option>
        <option value="completed">–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ</option>
      </select>
      <button onclick="loadOrders()">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
    </div>

    <div class="card">
      <h3>–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</h3>
      <div id="ordersList"></div>
    </div>
  </div>
</div>

<script>
let categories=[], products=[], reviews=[], promotions=[], orders=[];

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
async function loadCats(){
  categories = await (await fetch('/api/categories')).json();
  const s = document.getElementById('category');
  const s2 = document.getElementById('reviewCategory');
  s.innerHTML = categories.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
  s2.innerHTML = '<option value="">–í—Å–µ —Ä–∞–∑–¥–µ–ª—ã</option>' + categories.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
  renderCategoriesList();
  await loadProducts();
}
async function loadProducts(){
  const catId = document.getElementById('category').value;
  products = await (await fetch('/api/admin/products?category_id='+(catId || ''))).json();
  const p = document.getElementById('product');
  const p2 = document.getElementById('reviewProduct');
  p.innerHTML = '<option value="">‚Äî –Ω–æ–≤—ã–π ‚Äî</option>' + products.map(x=>`<option value="${x.id}">${x.name}</option>`).join('');
  p2.innerHTML = '<option value="">–í—Å–µ —Ç–æ–≤–∞—Ä—ã</option>' + products.map(x=>`<option value="${x.id}">${x.name}</option>`).join('');
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
    
    tab.classList.add('active');
    document.getElementById(tab.dataset.tab + 'Tab').style.display = 'block';
  });
});

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞–º–∏
function openCreateProduct(){
  const cat = document.getElementById('category').value;
  if (!cat) return alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª');
  renderProductForm({category_id:cat});
}
function openEditProduct(){
  const id = document.getElementById('product').value;
  if(!id) return alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä');
  const item = products.find(x=> x.id==id);
  renderProductForm(item);
}
async function openDeleteProduct(){
  const id = document.getElementById('product').value;
  if(!id) return alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä');
  if(!confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä?')) return;
  const r = await fetch('/api/admin/products/'+id,{method:'DELETE'});
  if((await r.json()).deleted>=1){ alert('–£–¥–∞–ª–µ–Ω–æ'); loadProducts(); }
}

function renderProductForm(item){
  const el = document.getElementById('productForm'); el.style.display='block';
  el.innerHTML = `
    <h3>${item.id ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ' : '–°–æ–∑–¥–∞–Ω–∏–µ'} —Ç–æ–≤–∞—Ä–∞</h3>
    <div class="row"><input id="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" value="${item?.name||''}" style="flex:1"></div>
    <div class="row"><textarea id="description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" rows="4" style="flex:1">${item?.description||''}</textarea></div>
    <div class="row">
      <input id="price" type="number" placeholder="–¶–µ–Ω–∞" value="${item?.price||''}">
      <input id="stock" placeholder="–û—Å—Ç–∞—Ç–æ–∫ (—Å—Ç—Ä–æ–∫–æ–π)" value="${item?.stock||''}" style="flex:1">
    </div>
    <div class="row">
      <input type="file" id="productImage" accept="image/*">
      ${item?.image_url ? `<img src="${item.image_url}" style="width:100px; height:100px; object-fit:cover; border-radius:8px">` : ''}
    </div>
    <div class="row">
      <input type="file" id="productImages" accept="image/*" multiple>
      <button class="muted" onclick="uploadProductImages(${item?.id||0})">–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–æ—Ç–æ</button>
    </div>
    <div class="row"><button onclick="saveProduct(${item?.id||''})">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
  `;
}

async function saveProduct(id){
  const formData = new FormData();
  formData.append('category_id', document.getElementById('category').value);
  formData.append('name', document.getElementById('name').value);
  formData.append('description', document.getElementById('description').value);
  formData.append('price', document.getElementById('price').value);
  formData.append('stock', document.getElementById('stock').value);
  
  if (document.getElementById('productImage').files[0]) {
    formData.append('image', document.getElementById('productImage').files[0]);
  }
  
  const method = id ? 'PUT' : 'POST';
  const url = id ? '/api/admin/products/'+id : '/api/admin/products';
  const r = await fetch(url, { method, body: formData });
  const data = await r.json();
  alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ'); 
  loadProducts();
  document.getElementById('productForm').style.display = 'none';
}

async function uploadProductImages(id){
  if(!id){ alert('–°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ç–æ–≤–∞—Ä'); return; }
  const f = document.getElementById('productImages').files;
  const fd = new FormData(); 
  for(const file of f) fd.append('images', file);
  const r = await fetch('/api/admin/products/'+id+'/images', {method:'POST', body:fd});
  if(r.ok) alert('–§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
}

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞–º–∏
function openCreateCategory(){
  renderCategoryForm({});
}
function openEditCategory(){
  const id = prompt('–í–≤–µ–¥–∏—Ç–µ ID —Ä–∞–∑–¥–µ–ª–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:');
  if(!id) return;
  const item = categories.find(x=> x.id==id);
  if(!item) return alert('–†–∞–∑–¥–µ–ª –Ω–µ –Ω–∞–π–¥–µ–Ω');
  renderCategoryForm(item);
}
async function openDeleteCategory(){
  const id = prompt('–í–≤–µ–¥–∏—Ç–µ ID —Ä–∞–∑–¥–µ–ª–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:');
  if(!id) return;
  if(!confirm('–£–¥–∞–ª–∏—Ç—å —Ä–∞–∑–¥–µ–ª?')) return;
  const r = await fetch('/api/admin/categories/'+id,{method:'DELETE'});
  if((await r.json()).deleted>=1){ alert('–£–¥–∞–ª–µ–Ω–æ'); loadCats(); }
}

function renderCategoryForm(item){
  const el = document.getElementById('categoryForm'); el.style.display='block';
  el.innerHTML = `
    <h3>${item.id ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ' : '–°–æ–∑–¥–∞–Ω–∏–µ'} —Ä–∞–∑–¥–µ–ª–∞</h3>
    <div class="row"><input id="catName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" value="${item?.name||''}" style="flex:1"></div>
    <div class="row"><textarea id="catDescription" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" rows="3" style="flex:1">${item?.description||''}</textarea></div>
    <div class="row">
      <input id="catPosition" type="number" placeholder="–ü–æ–∑–∏—Ü–∏—è" value="${item?.position||0}">
      <input type="file" id="categoryImage" accept="image/*">
      ${item?.image_url ? `<img src="${item.image_url}" style="width:100px; height:100px; object-fit:cover; border-radius:8px">` : ''}
    </div>
    <div class="row"><button onclick="saveCategory(${item?.id||''})">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
  `;
}

async function saveCategory(id){
  const formData = new FormData();
  formData.append('name', document.getElementById('catName').value);
  formData.append('description', document.getElementById('catDescription').value);
  formData.append('position', document.getElementById('catPosition').value);
  
  if (document.getElementById('categoryImage').files[0]) {
    formData.append('image', document.getElementById('categoryImage').files[0]);
  }
  
  const method = id ? 'PUT' : 'POST';
  const url = id ? '/api/admin/categories/'+id : '/api/admin/categories';
  const r = await fetch(url, { method, body: formData });
  const data = await r.json();
  alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ'); 
  loadCats();
  document.getElementById('categoryForm').style.display = 'none';
}

function renderCategoriesList(){
  const list = document.getElementById('categoriesList');
  list.innerHTML = categories.map(cat => `
    <div style="padding:10px; border-bottom:1px solid #eee;">
      <strong>${cat.name}</strong> (ID: ${cat.id})
      <div>${cat.description || ''}</div>
    </div>
  `).join('');
}

// –ú–æ–¥–µ—Ä–∞—Ü–∏—è –æ—Ç–∑—ã–≤–æ–≤
async function loadReviews(){
  const catId = document.getElementById('reviewCategory').value;
  const productId = document.getElementById('reviewProduct').value;
  let url = '/api/admin/reviews?';
  if (catId) url += `category_id=${catId}&`;
  if (productId) url += `product_id=${productId}`;
  
  reviews = await (await fetch(url)).json();
  renderReviewsList();
}

function renderReviewsList(){
  const list = document.getElementById('reviewsList');
  list.innerHTML = reviews.length > 0 ? reviews.map(review => `
    <div style="padding:10px; border-bottom:1px solid #eee; margin-bottom:10px;">
      <div><strong>–û—Ç–∑—ã–≤ –Ω–∞ "${review.product_name}" –æ—Ç ${review.username}</strong></div>
      <div>–†–µ–π—Ç–∏–Ω–≥: ${'‚òÖ'.repeat(review.rating)}${'‚òÜ'.repeat(5 - review.rating)}</div>
      <div>${review.text}</div>
      <div style="margin-top:10px;">
        <textarea id="adminComment_${review.id}" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –º–∞–≥–∞–∑–∏–Ω–∞" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ddd;">${review.admin_comment || ''}</textarea>
        <div style="display:flex; gap:8px; margin-top:8px;">
          <button class="muted" onclick="approveReview(${review.id})">–û–¥–æ–±—Ä–∏—Ç—å</button>
          <button class="muted" onclick="deleteReview(${review.id})">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
      </div>
    </div>
  `).join('') : '<div>–ù–µ—Ç –æ—Ç–∑—ã–≤–æ–≤ –¥–ª—è –º–æ–¥–µ—Ä–∞—Ü–∏–∏</div>';
}

async function approveReview(id){
  const adminComment = document.getElementById(`adminComment_${id}`).value;
  const r = await fetch('/api/admin/reviews/'+id+'/approve', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({admin_comment: adminComment})
  });
  if((await r.json()).approved>=1) {
    alert('–û—Ç–∑—ã–≤ –æ–¥–æ–±—Ä–µ–Ω');
    loadReviews();
  }
}

async function deleteReview(id){
  if(!confirm('–£–¥–∞–ª–∏—Ç—å –æ—Ç–∑—ã–≤?')) return;
  const r = await fetch('/api/admin/reviews/'+id,{method:'DELETE'});
  if((await r.json()).deleted>=1) {
    alert('–û—Ç–∑—ã–≤ —É–¥–∞–ª–µ–Ω');
    loadReviews();
  }
}

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–∫—Ü–∏—è–º–∏
async function loadPromotions(){
  promotions = await (await fetch('/api/admin/promotions')).json();
  renderPromotionsList();
}

function openCreatePromotion(){
  renderPromotionForm({});
}

function renderPromotionForm(item){
  const el = document.getElementById('promotionForm'); el.style.display='block';
  el.innerHTML = `
    <h3>${item.id ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ' : '–°–æ–∑–¥–∞–Ω–∏–µ'} –∞–∫—Ü–∏–∏</h3>
    <div class="row"><input id="promoTitle" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫" value="${item?.title||''}" style="flex:1"></div>
    <div class="row"><textarea id="promoContent" placeholder="–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ" rows="5" style="flex:1">${item?.content||''}</textarea></div>
    <div class="row">
      <input type="file" id="promoImage" accept="image/*">
      ${item?.image_url ? `<img src="${item.image_url}" style="width:100px; height:100px; object-fit:cover; border-radius:8px">` : ''}
    </div>
    <div class="row">
      <button onclick="savePromotion(${item?.id||''})">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      ${item?.id ? `<button class="muted" onclick="deletePromotion(${item.id})">–£–¥–∞–ª–∏—Ç—å</button>` : ''}
    </div>
  `;
}

async function savePromotion(id){
  const formData = new FormData();
  formData.append('title', document.getElementById('promoTitle').value);
  formData.append('content', document.getElementById('promoContent').value);
  
  if (document.getElementById('promoImage').files[0]) {
    formData.append('image', document.getElementById('promoImage').files[0]);
  }
  
  const method = id ? 'PUT' : 'POST';
  const url = id ? '/api/admin/promotions/'+id : '/api/admin/promotions';
  const r = await fetch(url, { method, body: formData });
  const data = await r.json();
  alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ'); 
  loadPromotions();
  document.getElementById('promotionForm').style.display = 'none';
}

async function deletePromotion(id){
  if(!confirm('–£–¥–∞–ª–∏—Ç—å –∞–∫—Ü–∏—é?')) return;
  const r = await fetch('/api/admin/promotions/'+id,{method:'DELETE'});
  if((await r.json()).deleted>=1) {
    alert('–ê–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∞');
    loadPromotions();
    document.getElementById('promotionForm').style.display = 'none';
  }
}

function renderPromotionsList(){
  const list = document.getElementById('promotionsList');
  list.innerHTML = promotions.length > 0 ? promotions.map(promo => `
    <div style="padding:10px; border-bottom:1px solid #eee; margin-bottom:10px;">
      <div style="display:flex; justify-content:space-between;">
        <strong>${promo.title}</strong>
        <span>${promo.active ? '‚úÖ –ê–∫—Ç–∏–≤–Ω–∞' : '‚ùå –ù–µ–∞–∫—Ç–∏–≤–Ω–∞'}</span>
      </div>
      <div>${promo.content}</div>
      ${promo.image_url ? `<img src="${promo.image_url}" style="max-width:200px; max-height:200px; margin-top:10px;">` : ''}
      <div style="margin-top:10px;">
        <button class="muted" onclick="editPromotion(${promo.id})">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
      </div>
    </div>
  `).join('') : '<div>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–∫—Ü–∏–π</div>';
}

function editPromotion(id){
  const promo = promotions.find(p => p.id == id);
  renderPromotionForm(promo);
}

// –ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–∫–∞–∑–æ–≤
async function loadOrders(){
  const startDate = document.getElementById('startDate').value;
  const endDate = document.getElementById('endDate').value;
  const status = document.getElementById('orderStatus').value;
  
  let url = '/api/admin/orders?';
  if (startDate) url += `start_date=${startDate}&`;
  if (endDate) url += `end_date=${endDate}&`;
  if (status) url += `status=${status}`;
  
  orders = await (await fetch(url)).json();
  renderOrdersList();
}

function renderOrdersList(){
  const list = document.getElementById('ordersList');
  list.innerHTML = orders.length > 0 ? orders.map(order => `
    <div style="padding:10px; border-bottom:1px solid #eee; margin-bottom:10px;">
      <div style="display:flex; justify-content:space-between;">
        <strong>–ó–∞–∫–∞–∑ #${order.id}</strong>
        <span>${new Date(order.created_at).toLocaleDateString()}</span>
      </div>
      <div>–ö–ª–∏–µ–Ω—Ç: ${order.username}</div>
      <div>–¢–æ–≤–∞—Ä—ã: ${order.items_list}</div>
      <div>–°—É–º–º–∞: ${order.total} —Ä—É–±.</div>
      <div>–°–ø–æ—Å–æ–± –¥–æ—Å—Ç–∞–≤–∫–∏: ${order.delivery_method}</div>
      ${order.delivery_address ? `<div>–ê–¥—Ä–µ—Å: ${order.delivery_address}</div>` : ''}
      ${order.delivery_point ? `<div>–ü—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏: ${order.delivery_point}</div>` : ''}
      <div>–°—Ç–∞—Ç—É—Å: ${order.status}</div>
    </div>
  `).join('') : '<div>–ó–∞–∫–∞–∑–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
(async ()=>{ 
  await loadCats(); 
  await loadPromotions();
})();
</script>
</body>
</html>