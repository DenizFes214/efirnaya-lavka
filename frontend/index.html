<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üåø –≠—Ñ–∏—Ä–Ω–∞—è –õ–∞–≤–∫–∞ ‚ú®</title>
  <link rel="icon" href="/static/icons/witch_broom.png">
  <link rel="stylesheet" href="/static/css/tma-styles.css">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
    .image-viewer-nav{position:absolute; top:50%; transform:translateY(-50%); color:#fff; font-size:30px; cursor:pointer; background:rgba(0,0,0,0.5); border-radius:50%; width:50px; height:50px; display:flex; justify-content:center; align-items:center;}
    .image-viewer-prev{left:20px;}
    .image-viewer-next{right:20px;}
    .delivery-option{margin-bottom:15px; padding:10px; border:1px solid #ddd; border-radius:8px;}
    .delivery-fields{margin-top:10px; padding:10px; background:#f9f9f9; border-radius:6px;}
    .admin-modal{position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.95); z-index:1000; display:none; overflow:auto; padding:10px; box-sizing:border-box;}
    .admin-header{display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; padding-bottom:10px; border-bottom:1px solid #eee; background:#fff; padding:15px; border-radius:8px;}
    .admin-close{font-size:24px; cursor:pointer; padding:5px 10px;}
    .admin-tabs{display:flex; flex-wrap:wrap; gap:5px; margin-bottom:15px;}
    .admin-tab{padding:8px 12px; background:#f0f0f0; border-radius:8px; cursor:pointer; font-size:14px; white-space:nowrap;}
    .admin-tab.active{background:#8a2be2; color:white;}
    .admin-form{background:#fff; padding:15px; border-radius:8px; margin-bottom:15px;}
    .admin-form input, .admin-form textarea, .admin-form select{width:100%; padding:12px; margin-bottom:10px; border:1px solid #ddd; border-radius:6px; box-sizing:border-box; font-size:16px;}
    .admin-form button{padding:12px 15px; background:#8a2be2; color:white; border:none; border-radius:6px; cursor:pointer; margin-right:8px; font-size:16px;}
    .admin-list-item{background:#fff; padding:15px; margin-bottom:10px; border-radius:8px;}
    .admin-content{max-width:100%; overflow-x:auto;}
    
    @media (max-width: 480px) {
      .admin-tab {
        padding: 6px 10px;
        font-size: 12px;
      }
      
      .admin-form input, 
      .admin-form textarea, 
      .admin-form select {
        font-size: 14px;
        padding: 10px;
      }
      
      .admin-form button {
        padding: 10px 12px;
        font-size: 14px;
      }
    }
  </style>
</head>
<body class="tg-viewport">
  
  <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ª–∞–≤–∫–∏ -->
  <header class="shop-header">
    <h1>üåø –≠—Ñ–∏—Ä–Ω–∞—è –õ–∞–≤–∫–∞ ‚ú®</h1>
    <p>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –º–∏—Ä –¥—Ä–µ–≤–Ω–µ–π –º—É–¥—Ä–æ—Å—Ç–∏</p>
    <div id="adminButton" class="admin-btn" style="display:none;">üßô‚Äç‚ôÄÔ∏è –ê–ª—Ç–∞—Ä—å –ß–∞—Ä–æ–¥–µ–π–∫–∏</div>
  </header>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
  <main id="app" class="container">
    
    <!-- –≠–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div id="loadingScreen" class="magical-loader">
      <span class="spinner">üîÆ</span>
      <p>–ó–∞–∂–∏–≥–∞–µ–º —Å–≤–µ—á–∏...</p>
    </div>

    <!-- –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ -->
    <div id="homeScreen" style="display:none;">
      <div class="magical-container">
        <h2>üóùÔ∏è –¢–∞–π–Ω—ã–µ –ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h2>
        <div class="categories-grid" id="categoriesGrid">
          <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
      </div>
    </div>

    <!-- –≠–∫—Ä–∞–Ω –∫–∞—Ç–∞–ª–æ–≥–∞ —Ç–æ–≤–∞—Ä–æ–≤ -->
    <div id="catalogScreen" style="display:none;">
      <div class="magical-container">
        <h2 id="categoryTitle">–ö–∞—Ç–∞–ª–æ–≥</h2>
        <div class="product-grid" id="productGrid">
          <!-- –¢–æ–≤–∞—Ä—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
      </div>
    </div>

    <!-- –≠–∫—Ä–∞–Ω —Ç–æ–≤–∞—Ä–∞ -->
    <div id="productScreen" style="display:none;">
      <div class="magical-container" id="productDetails">
        <!-- –î–µ—Ç–∞–ª–∏ —Ç–æ–≤–∞—Ä–∞ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
      </div>
    </div>

    <!-- –≠–∫—Ä–∞–Ω –∫–æ—Ä–∑–∏–Ω—ã -->
    <div id="cartScreen" style="display:none;">
      <div class="magical-container">
        <h2>üõí –í–æ–ª—à–µ–±–Ω–∞—è –ö–æ—Ä–∑–∏–Ω–∞</h2>
        <div id="cartItems">
          <!-- –¢–æ–≤–∞—Ä—ã –≤ –∫–æ—Ä–∑–∏–Ω–µ -->
        </div>
        <div id="cartSummary" style="display:none;">
          <!-- –ò—Ç–æ–≥–∏ –∑–∞–∫–∞–∑–∞ -->
        </div>
      </div>
    </div>

    <!-- –≠–∫—Ä–∞–Ω –∑–∞–∫–∞–∑–æ–≤ -->
    <div id="ordersScreen" style="display:none;">
      <div class="magical-container">
        <h2>üìú –ò—Å—Ç–æ—Ä–∏—è –ó–∞–∫–∞–∑–æ–≤</h2>
        <div id="ordersList">
          <!-- –°–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤ -->
        </div>
      </div>
    </div>

  </main>

  <!-- –ù–∏–∂–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è -->
  <nav class="bottom-nav">
    <div class="nav-container">
      <a href="#" class="nav-item active" onclick="showScreen('home')" id="nav-home">
        <span class="nav-icon">üè†</span>
        <span class="nav-label">–ì–ª–∞–≤–Ω–∞—è</span>
      </a>
      <a href="#" class="nav-item" onclick="showScreen('catalog')" id="nav-catalog">
        <span class="nav-icon">üìö</span>
        <span class="nav-label">–ö–∞—Ç–∞–ª–æ–≥</span>
      </a>
      <a href="#" class="nav-item" onclick="showScreen('cart')" id="nav-cart">
        <span class="nav-icon">üõí</span>
        <span class="nav-label">–ö–æ—Ä–∑–∏–Ω–∞</span>
        <span class="cart-count" id="cartCount" style="display:none;">0</span>
      </a>
      <a href="#" class="nav-item" onclick="showScreen('orders')" id="nav-orders">
        <span class="nav-icon">üìú</span>
        <span class="nav-label">–ó–∞–∫–∞–∑—ã</span>
      </a>
    </div>
  </nav>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π -->
<div id="imageViewer" class="image-viewer">
  <span class="image-viewer-close" onclick="closeImageViewer()">√ó</span>
  <span class="image-viewer-nav image-viewer-prev" onclick="changeImage(-1)">‚Äπ</span>
  <img id="viewerImage" src="" alt="">
  <span class="image-viewer-nav image-viewer-next" onclick="changeImage(1)">‚Ä∫</span>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ—à–∏–±–∫–∏ –¥–æ—Å—Ç—É–ø–∞ -->
<div id="errorModal" class="modal">
  <div class="modal-content">
    <h3 style="color:#d32f2f; margin-top:0;">–ü—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –≠—Ç–æ –Ω–µ —Ç–µ—Ä–ø–∏—Ç –ø–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö</h3>
    <p>–í–æ–∑–≤—Ä–∞—â–∞–π—Å—è –Ω–∞ —Ç—Ä–æ–ø—É, –ø—É—Ç–Ω–∏–∫. –í–æ–∑–º–æ–∂–Ω–æ, —Ç–µ–±–µ –Ω—É–∂–µ–Ω –∏–Ω–æ–π –∫–ª—é—á ‚Äî –∑–∞–≥–æ–≤–æ—Ä—ë–Ω–Ω–æ–µ —Å–ª–æ–≤–æ, –æ—Å–æ–±–∞—è —Ç—Ä–∞–≤–∞ –∏–ª–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ —Å–∞–º–æ–π –•—Ä–∞–Ω–∏—Ç–µ–ª—å–Ω–∏—Ü—ã –ê—Ä–æ–º–∞—Ç–æ–≤. –ò–ª–∏ –∂–µ... –±—ã—Ç—å –º–æ–∂–µ—Ç, —Ç—ã –ø—Ä–æ—Å—Ç–æ –∑–∞–±–ª—É–¥–∏–ª—Å—è –≤ —á–∞—â–µ –∫–æ–¥–æ–≤ –∏ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–π?</p>
    <button onclick="document.getElementById('errorModal').style.display='none'" style="margin-top:15px; padding:8px 16px; background:#d32f2f; color:white; border:none; border-radius:6px;">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ -->
<div id="adminModal" class="admin-modal">
  <div class="admin-content">
    <div class="admin-header">
      <h2>–ê–ª—Ç–∞—Ä—å –ß–∞—Ä–æ–¥–µ–π–∫–∏</h2>
      <span class="admin-close" onclick="hideAdminModal()">√ó</span>
    </div>

    <div class="admin-tabs">
      <div class="admin-tab active" data-tab="products">–¢–æ–≤–∞—Ä—ã</div>
      <div class="admin-tab" data-tab="categories">–†–∞–∑–¥–µ–ª—ã</div>
      <div class="admin-tab" data-tab="reviews">–û—Ç–∑—ã–≤—ã</div>
      <div class="admin-tab" data-tab="promotions">–ê–∫—Ü–∏–∏</div>
      <div class="admin-tab" data-tab="orders">–ó–∞–∫–∞–∑—ã</div>
    </div>

    <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞–º–∏ -->
    <div id="adminProductsTab" class="admin-tab-content">
      <div class="admin-form">
        <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞–º–∏</h3>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;">
          <div>
            <label>–†–∞–∑–¥–µ–ª:</label>
            <select id="adminCategorySelect" onchange="loadAdminProducts()">
              <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª</option>
            </select>
          </div>
          <div>
            <label>–¢–æ–≤–∞—Ä:</label>
            <select id="adminProductSelect">
              <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä</option>
            </select>
          </div>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button onclick="adminCreateProduct()">–°–æ–∑–¥–∞—Ç—å</button>
          <button onclick="adminEditProduct()">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
          <button onclick="adminDeleteProduct()">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
      </div>

      <div id="adminProductForm" class="admin-form" style="display:none;">
        <h3 id="productFormTitle">–°–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</h3>
        <input type="text" id="productName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞">
        <textarea id="productDescription" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞" rows="3"></textarea>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
          <input type="number" id="productPrice" placeholder="–¶–µ–Ω–∞">
          <input type="text" id="productStock" placeholder="–û—Å—Ç–∞—Ç–æ–∫">
        </div>
        <input type="file" id="productImage" accept="image/*">
        <div style="margin-top:15px;">
          <button onclick="adminSaveProduct()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button onclick="document.getElementById('adminProductForm').style.display='none'">–û—Ç–º–µ–Ω–∞</button>
        </div>
      </div>
    </div>

    <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞–º–∏ -->
    <div id="adminCategoriesTab" class="admin-tab-content" style="display:none;">
      <div class="admin-form">
        <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞–º–∏</h3>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button onclick="adminCreateCategory()">–°–æ–∑–¥–∞—Ç—å</button>
          <button onclick="adminEditCategory()">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
          <button onclick="adminDeleteCategory()">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
      </div>

      <div id="adminCategoryForm" class="admin-form" style="display:none;">
        <h3 id="categoryFormTitle">–°–æ–∑–¥–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞</h3>
        <input type="text" id="categoryName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞">
        <textarea id="categoryDescription" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞" rows="3"></textarea>
        <input type="number" id="categoryPosition" placeholder="–ü–æ–∑–∏—Ü–∏—è" value="0">
        <input type="file" id="categoryImage" accept="image/*">
        <div style="margin-top:15px;">
          <button onclick="adminSaveCategory()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button onclick="document.getElementById('adminCategoryForm').style.display='none'">–û—Ç–º–µ–Ω–∞</button>
        </div>
      </div>

      <div id="adminCategoriesList"></div>
    </div>

    <!-- –ú–æ–¥–µ—Ä–∞—Ü–∏—è –æ—Ç–∑—ã–≤–æ–≤ -->
    <div id="adminReviewsTab" class="admin-tab-content" style="display:none;">
      <div class="admin-form">
        <h3>–ú–æ–¥–µ—Ä–∞—Ü–∏—è –æ—Ç–∑—ã–≤–æ–≤</h3>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;">
          <div>
            <label>–†–∞–∑–¥–µ–ª:</label>
            <select id="adminReviewCategorySelect" onchange="loadAdminReviewProducts()">
              <option value="">–í—Å–µ —Ä–∞–∑–¥–µ–ª—ã</option>
            </select>
          </div>
          <div>
            <label>–¢–æ–≤–∞—Ä:</label>
            <select id="adminReviewProductSelect">
              <option value="">–í—Å–µ —Ç–æ–≤–∞—Ä—ã</option>
            </select>
          </div>
        </div>
        <button onclick="adminLoadReviews()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –æ—Ç–∑—ã–≤—ã</button>
      </div>

      <div id="adminReviewsList"></div>
    </div>

    <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–∫—Ü–∏—è–º–∏ -->
    <div id="adminPromotionsTab" class="admin-tab-content" style="display:none;">
      <div class="admin-form">
        <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–∫—Ü–∏—è–º–∏</h3>
        <button onclick="adminCreatePromotion()">–°–æ–∑–¥–∞—Ç—å –∞–∫—Ü–∏—é</button>
      </div>

      <div id="adminPromotionForm" class="admin-form" style="display:none;">
        <h3 id="promotionFormTitle">–°–æ–∑–¥–∞–Ω–∏–µ –∞–∫—Ü–∏–∏</h3>
        <input type="text" id="promotionTitle" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∞–∫—Ü–∏–∏">
        <textarea id="promotionContent" placeholder="–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –∞–∫—Ü–∏–∏" rows="5"></textarea>
        <input type="file" id="promotionImage" accept="image/*">
        <div style="margin-top:15px;">
          <button onclick="adminSavePromotion()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button onclick="document.getElementById('adminPromotionForm').style.display='none'">–û—Ç–º–µ–Ω–∞</button>
        </div>
      </div>

      <div id="adminPromotionsList"></div>
    </div>

    <!-- –ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–∫–∞–∑–æ–≤ -->
    <div id="adminOrdersTab" class="admin-tab-content" style="display:none;">
      <div class="admin-form">
        <h3>–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</h3>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;">
          <div>
            <label>–°:</label>
            <input type="date" id="adminStartDate">
          </div>
          <div>
            <label>–ü–æ:</label>
            <input type="date" id="adminEndDate">
          </div>
        </div>
        <div style="margin-bottom:15px;">
          <label>–°—Ç–∞—Ç—É—Å:</label>
          <select id="adminOrderStatus">
            <option value="">–í—Å–µ</option>
            <option value="new">–ù–æ–≤—ã–µ</option>
            <option value="processing">–í –æ–±—Ä–∞–±–æ—Ç–∫–µ</option>
            <option value="completed">–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ</option>
          </select>
        </div>
        <button onclick="adminLoadOrders()">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
      </div>

      <div id="adminOrdersList"></div>
    </div>
  </div>
</div>

<nav class="bottom-nav" id="bottomNav">
  <button type="button" class="tile" data-tab="categories">
    <span>üì¶</span>
    <span>–ö–∞—Ç–∞–ª–æ–≥</span>
  </button>
  <button type="button" class="tile" data-tab="favorites">
    <span>‚ù§Ô∏è</span>
    <span>–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</span>
  </button>
  <button type="button" class="tile" data-tab="cart">
    <span>üõí</span>
    <span>–ö–æ—Ä–∑–∏–Ω–∞</span>
  </button>
  <button type="button" class="tile" data-tab="promotions">
    <span>üéÅ</span>
    <span>–ê–∫—Ü–∏–∏</span>
  </button>
</nav>

<script>
const state = {
  tab: 'categories',
  categories: [],
  products: [],
  currentCategory: null,
  favorites: new Set(JSON.parse(localStorage.getItem('favorites') || '[]')),
  cart: JSON.parse(localStorage.getItem('cart') || '[]'),
  isAdmin: false,
  showAdminMenu: false,
  currentProductImages: [],
  currentImageIndex: 0,
  adminCategories: [],
  adminProducts: [],
  adminPromotions: []
};

function saveFav() { localStorage.setItem('favorites', JSON.stringify([...state.favorites])); }
function saveCart() { localStorage.setItem('cart', JSON.stringify(state.cart)); }

async function fetchJSON(u) { 
  try {
    const r = await fetch(u); 
    return r.json();
  } catch (error) {
    console.error('Fetch error:', error);
    return [];
  }
}

async function loadCategories() {
  state.categories = await fetchJSON('/api/categories');
  console.log('Loaded categories:', state.categories.length);
}

async function loadProducts(categoryId = null) {
  const url = categoryId ? `/api/products?category_id=${categoryId}` : '/api/products';
  state.products = await fetchJSON(url);
  console.log('Loaded products:', state.products.length);
}

async function checkAdmin() {
  try {
    let userId = null;
    
    if (window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user) {
      userId = Telegram.WebApp.initDataUnsafe.user.id;
    }
    
    if (!userId) {
      const urlParams = new URLSearchParams(window.location.search);
      userId = urlParams.get('user_id');
    }
    
    if (!userId) {
      userId = localStorage.getItem('admin_user_id');
    }
    
    if (userId) {
      localStorage.setItem('admin_user_id', userId);
      
      const response = await fetch(`/api/admin/check?user_id=${userId}`);
      const data = await response.json();
      state.isAdmin = data.isAdmin;
      
      document.getElementById('adminButton').style.display = state.isAdmin ? 'block' : 'none';
    }
  } catch (error) {
    console.error('Admin check failed:', error);
    state.isAdmin = false;
    document.getElementById('adminButton').style.display = 'none';
  }
}

function render() {
  const app = document.getElementById('app');
  
  if (state.tab === 'categories') {
    app.innerHTML = '<div class="grid">' + 
      state.categories.map(cat => `
        <div class="card" onclick="selectCategory(${cat.id})">
          <img src="${cat.image_url || '/static/assets/category-placeholder.png'}" alt="${cat.name}"/>
          <div><strong>${cat.name}</strong></div>
          <div>${cat.description || ''}</div>
        </div>
      `).join('') + '</div>';
  } 
  else if (state.tab === 'products' && state.currentCategory) {
    const categoryProducts = state.products.filter(p => p.category_id == state.currentCategory.id);
    app.innerHTML = `
      <div style="padding:12px">
        <button class="btn" onclick="backToCategories()">‚Üê –ù–∞–∑–∞–¥ –∫ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</button>
        <h2>${state.currentCategory.name}</h2>
        <div class="grid">
          ${categoryProducts.length > 0 ? categoryProducts.map(p => `
            <div class="card">
              <img src="${p.image_url || '/static/assets/product-placeholder.png'}" alt="${p.name}" onclick="viewProduct(${p.id})"/>
              <div>${p.name}</div>
              <div class="price">${(p.price || 0).toFixed(2)} ‚ÇΩ</div>
              <div style="display:flex; gap:8px">
                <button class="btn" onclick="viewProduct(${p.id})">–û—Ç–∫—Ä—ã—Ç—å</button>
                <button class="btn fav" onclick="toggleFav(${p.id})">${state.favorites.has(p.id) ? '‚òÖ' : '‚òÜ'}</button>
              </div>
            </div>
          `).join('') : '<div style="padding:20px; text-align:center">–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>'}
        </div>
      </div>
    `;
  }
  else if (state.tab === 'favorites') {
    const favList = state.products.filter(p => state.favorites.has(p.id));
    app.innerHTML = '<div class="grid">' + (favList.length > 0 ? favList.map(p => `
      <div class="card">
        <img src="${p.image_url || ''}" alt="${p.name}" onclick="viewProduct(${p.id})"/>
        <div>${p.name}</div>
        <div class="price">${p.price} ‚ÇΩ</div>
        <button class="btn" onclick="viewProduct(${p.id})">–û—Ç–∫—Ä—ã—Ç—å</button>
      </div>
    `).join('') : '<div style="padding:20px; text-align:center">–ù–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤</div>') + '</div>';
  }
  else if (state.tab === 'cart') {
    const total = state.cart.reduce((s, i) => s + i.price * i.qty, 0);
    app.innerHTML = `
      <div style="padding:12px">
        <h2>–ö–æ—Ä–∑–∏–Ω–∞</h2>
        <button class="btn" onclick="state.tab='categories'; render();" style="margin-bottom:16px;">‚Üê –ù–∞–∑–∞–¥ –∑–∞ –ø–æ–∫—É–ø–∫–∞–º–∏</button>
        ${state.cart.length > 0 ? state.cart.map((i, idx) => `
          <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px">
            <div style="flex:1">${i.name}</div>
            <div>${i.qty} √ó ${i.price} ‚ÇΩ</div>
            <button class="btn" onclick="decQty(${idx})">-</button>
            <button class="btn" onclick="incQty(${idx})">+</button>
            <button class="btn" onclick="rmItem(${idx})">√ó</button>
          </div>
        `).join('') + `
        <hr>
        <h3>–°–ø–æ—Å–æ–± –¥–æ—Å—Ç–∞–≤–∫–∏</h3>
        <div class="delivery-option">
          <input type="radio" id="pickup" name="delivery" value="pickup" checked>
          <label for="pickup">–°–∞–º–æ–≤—ã–≤–æ–∑</label>
        </div>
        <div class="delivery-option">
          <input type="radio" id="post" name="delivery" value="post">
          <label for="post">–ü–æ—á—Ç–∞ –†–æ—Å—Å–∏–∏</label>
          <div id="postFields" class="delivery-fields" style="display:none">
            <input type="text" id="postIndex" placeholder="–ò–Ω–¥–µ–∫—Å" style="width:100%; margin-bottom:5px">
            <input type="text" id="postCity" placeholder="–ì–æ—Ä–æ–¥" style="width:100%; margin-bottom:5px">
            <input type="text" id="postStreet" placeholder="–£–ª–∏—Ü–∞" style="width:100%; margin-bottom:5px">
            <input type="text" id="postHouse" placeholder="–î–æ–º" style="width:100%; margin-bottom:5px">
            <input type="text" id="postApartment" placeholder="–ö–≤–∞—Ä—Ç–∏—Ä–∞" style="width:100%">
          </div>
        </div>
        <div class="delivery-option">
          <input type="radio" id="yandex" name="delivery" value="yandex">
          <label for="yandex">–Ø–Ω–¥–µ–∫—Å –¥–æ—Å—Ç–∞–≤–∫–∞</label>
          <div id="yandexFields" class="delivery-fields" style="display:none">
            <input type="text" id="yandexPoint" placeholder="–ü—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏" style="width:100%">
          </div>
        </div>
        <hr>
        <div><strong>–ò—Ç–æ–≥–æ:</strong> ${total.toFixed(2)} ‚ÇΩ</div>
        <button class="btn primary" onclick="checkout()">–û—Ñ–æ—Ä–º–∏—Ç—å</button>
        </div>` : '<div style="padding:20px; text-align:center">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>'}
      </div>
    `;
    
    document.querySelectorAll('input[name="delivery"]').forEach(input => {
      input.addEventListener('change', function() {
        document.getElementById('postFields').style.display = this.value === 'post' ? 'block' : 'none';
        document.getElementById('yandexFields').style.display = this.value === 'yandex' ? 'block' : 'none';
      });
    });
  }
  else if (state.tab === 'promotions') {
    fetch('/api/promotions')
      .then(r => r.json())
      .then(promotions => {
        app.innerHTML = '<div style="padding:12px">' +
          '<h2>–ê–∫—Ü–∏–∏</h2>' +
          (promotions.length > 0 ? promotions.map(p => `
            <div class="card" style="margin-bottom:15px">
              ${p.image_url ? `<img src="${p.image_url}" alt="${p.title}" style="width:100%; height:200px; object-fit:cover; border-radius:8px; margin-bottom:10px">` : ''}
              <h3>${p.title}</h3>
              <p>${p.content}</p>
            </div>
          `).join('') : '<div style="padding:20px; text-align:center">–ê–∫—Ü–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</div>') +
          '</div>';
      })
      .catch(() => {
        app.innerHTML = '<div style="padding:12px"><h2>–ê–∫—Ü–∏–∏</h2><p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞–∫—Ü–∏–∏</p></div>';
      });
  }
}

function selectCategory(categoryId) {
  state.currentCategory = state.categories.find(c => c.id === categoryId);
  state.tab = 'products';
  loadProducts(categoryId).then(render);
}

function backToCategories() {
  state.tab = 'categories';
  state.currentCategory = null;
  render();
}

function toggleFav(id) {
  if (state.favorites.has(id)) state.favorites.delete(id); 
  else state.favorites.add(id);
  saveFav(); 
  render();
}

function viewProduct(id) {
  const p = state.products.find(x => x.id === id); 
  if (!p) return;
  
  fetch('/api/product/' + id + '/images')
    .then(r => r.json())
    .then(images => {
      state.currentProductImages = images;
      if (images.length > 0) {
        openImageViewer(0);
      }
      
      const app = document.getElementById('app');
      app.innerHTML = `<div style="padding:12px">
        <button class="btn" onclick="backToProducts()">‚Üê –ù–∞–∑–∞–¥</button>
        ${images.length > 0 ? `<img src="${images[0]}" style="width:100%; max-height:240px; object-fit:cover; border-radius:12px; cursor:pointer" onclick="openImageViewer(0)"/>` : ''}
        <div class="gallery" id="gallery"></div>
        <h2>${p.name}</h2>
        <div class="price">${p.price} ‚ÇΩ</div>
        <p>${p.description || ''}</p>
        <div style="display:flex; gap:8px">
          <button class="btn primary" onclick="addToCart(${p.id})">–í –∫–æ—Ä–∑–∏–Ω—É</button>
          <button class="btn fav" onclick="toggleFav(${p.id})">${state.favorites.has(p.id) ? '‚òÖ' : '‚òÜ'}</button>
        </div>
        <div id="reviewsSection"></div>
      </div>`;
      
      fetch('/api/product/' + id + '/reviews')
        .then(r => r.json())
        .then(reviews => {
          const reviewsSection = document.getElementById('reviewsSection');
          if (reviews.length > 0) {
            reviewsSection.innerHTML = '<h3>–û—Ç–∑—ã–≤—ã</h3>' + reviews.map(r => `
              <div style="border:1px solid #eee; border-radius:8px; padding:10px; margin-bottom:10px">
                <div><strong>${r.username || '–ü–æ–∫—É–ø–∞—Ç–µ–ª—å'}</strong> ‚Ä¢ –†–µ–π—Ç–∏–Ω–≥: ${'‚òÖ'.repeat(r.rating)}${'‚òÜ'.repeat(5 - r.rating)}</div>
                <div>${r.text}</div>
                ${r.admin_comment ? `<div style="margin-top:8px; padding:8px; background:#f9f9f9; border-radius:4px"><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –º–∞–≥–∞–∑–∏–Ω–∞:</strong> ${r.admin_comment}</div>` : ''}
              </div>
            `).join('');
          }
        })
        .catch(() => {});
    })
    .catch(() => {});
}

function backToProducts() {
  state.tab = 'products';
  render();
}

function openImageViewer(index) {
  state.currentImageIndex = index;
  document.getElementById('viewerImage').src = state.currentProductImages[index];
  document.getElementById('imageViewer').style.display = 'flex';
}

function closeImageViewer() {
  document.getElementById('imageViewer').style.display = 'none';
}

function changeImage(direction) {
  let newIndex = state.currentImageIndex + direction;
  if (newIndex < 0) newIndex = state.currentProductImages.length - 1;
  if (newIndex >= state.currentProductImages.length) newIndex = 0;
  state.currentImageIndex = newIndex;
  document.getElementById('viewerImage').src = state.currentProductImages[newIndex];
}

function addToCart(pid) {
  const p = state.products.find(x => x.id === pid);
  const found = state.cart.find(x => x.id === pid);
  if (found) found.qty++; 
  else state.cart.push({id: p.id, name: p.name, price: p.price, qty: 1});
  saveCart(); 
  alert('–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É');
}

function decQty(i) { 
  state.cart[i].qty = Math.max(1, state.cart[i].qty - 1); 
  saveCart(); 
  render(); 
}

function incQty(i) { 
  state.cart[i].qty++; 
  saveCart(); 
  render(); 
}

function rmItem(i) { 
  state.cart.splice(i, 1); 
  saveCart(); 
  render(); 
}

async function checkout() {
  const deliveryMethod = document.querySelector('input[name="delivery"]:checked').value;
  let deliveryAddress = '';
  let deliveryPoint = '';
  
  if (deliveryMethod === 'post') {
    const index = document.getElementById('postIndex').value;
    const city = document.getElementById('postCity').value;
    const street = document.getElementById('postStreet').value;
    const house = document.getElementById('postHouse').value;
    const apartment = document.getElementById('postApartment').value;
    
    if (!index || !city || !street || !house) {
      alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –∞–¥—Ä–µ—Å–∞');
      return;
    }
    
    deliveryAddress = `–ò–Ω–¥–µ–∫—Å: ${index}, –ì–æ—Ä–æ–¥: ${city}, –£–ª–∏—Ü–∞: ${street}, –î–æ–º: ${house}, –ö–≤–∞—Ä—Ç–∏—Ä–∞: ${apartment}`;
  } else if (deliveryMethod === 'yandex') {
    deliveryPoint = document.getElementById('yandexPoint').value;
    if (!deliveryPoint) {
      alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –ø—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏');
      return;
    }
  }
  
  const comment = prompt('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–∫–∞–∑—É (–ø–æ–∂–µ–ª–∞–Ω–∏—è):', '');
  if (comment === null) return;
  
  const user = Telegram.WebApp.initDataUnsafe.user;
  const userId = user?.id || 0;
  const username = user?.username || user?.first_name || '–ü–æ–∫—É–ø–∞—Ç–µ–ª—å';
  
  const total = state.cart.reduce((s, i) => s + i.price * i.qty, 0);
  
  try {
    const r = await fetch('/api/orders', {
      method: 'POST', 
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        user_id: userId,
        username: username,
        items: state.cart, 
        total, 
        comment, 
        delivery_method: deliveryMethod,
        delivery_address: deliveryAddress,
        delivery_point: deliveryPoint
      })
    });
    
    if (!r.ok) {
      const errorText = await r.text();
      throw new Error(`HTTP error! status: ${r.status}, message: ${errorText}`);
    }
    
    const data = await r.json();
    if (data.id) { 
      alert('–ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω! ‚Ññ' + data.id); 
      state.cart = []; 
      saveCart(); 
      state.tab = 'categories'; 
      render(); 
    } else {
      throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑');
    }
  } catch (error) {
    console.error('Checkout error:', error);
    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞: ' + error.message);
  }
}

// –ê–¥–º–∏–Ω-—Ñ—É–Ω–∫—Ü–∏–∏
function showAdminModal() {
  document.getElementById('adminModal').style.display = 'flex';
  loadAdminCategories();
  loadAdminPromotions();
}

function hideAdminModal() {
  document.getElementById('adminModal').style.display = 'none';
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
document.querySelectorAll('.admin-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.admin-tab-content').forEach(t => t.style.display = 'none');
    
    tab.classList.add('active');
    document.getElementById('admin' + capitalize(tab.dataset.tab) + 'Tab').style.display = 'block';
  });
});

function capitalize(str) {
  return str.charAt(0).toUpperCase() + str.slice(1);
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–ª—è –∞–¥–º–∏–Ω–∫–∏
async function loadAdminCategories() {
  try {
    state.adminCategories = await fetchJSON('/api/categories');
    const categorySelect = document.getElementById('adminCategorySelect');
    const reviewCategorySelect = document.getElementById('adminReviewCategorySelect');
    
    categorySelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª</option>' + 
      state.adminCategories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    
    reviewCategorySelect.innerHTML = '<option value="">–í—Å–µ —Ä–∞–∑–¥–µ–ª—ã</option>' + 
      state.adminCategories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
  } catch (error) {
    console.error('Error loading categories:', error);
    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞–∑–¥–µ–ª–æ–≤');
  }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
async function loadAdminProducts() {
  const categoryId = document.getElementById('adminCategorySelect').value;
  if (!categoryId) {
    document.getElementById('adminProductSelect').innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä</option>';
    return;
  }
  
  try {
    state.adminProducts = await fetchJSON('/api/products?category_id=' + categoryId);
    const productSelect = document.getElementById('adminProductSelect');
    
    productSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä</option>' + 
      state.adminProducts.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
  } catch (error) {
    console.error('Error loading products:', error);
    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤');
  }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –æ—Ç–∑—ã–≤–æ–≤
async function loadAdminReviewProducts() {
  const categoryId = document.getElementById('adminReviewCategorySelect').value;
  let url = '/api/products';
  if (categoryId) url += '?category_id=' + categoryId;
  
  try {
    const products = await fetchJSON(url);
    const productSelect = document.getElementById('adminReviewProductSelect');
    
    productSelect.innerHTML = '<option value="">–í—Å–µ —Ç–æ–≤–∞—Ä—ã</option>' + 
      products.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
  } catch (error) {
    console.error('Error loading products for review:', error);
  }
}

// –°–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
function adminCreateProduct() {
  const categoryId = document.getElementById('adminCategorySelect').value;
  if (!categoryId) {
    alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª');
    return;
  }
  
  const form = document.getElementById('adminProductForm');
  form.style.display = 'block';
  document.getElementById('productFormTitle').textContent = '–°–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞';
  document.getElementById('productName').value = '';
  document.getElementById('productDescription').value = '';
  document.getElementById('productPrice').value = '';
  document.getElementById('productStock').value = '';
  document.getElementById('productImage').value = '';
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
async function adminSaveProduct() {
  const categoryId = document.getElementById('adminCategorySelect').value;
  const name = document.getElementById('productName').value;
  const description = document.getElementById('productDescription').value;
  const price = document.getElementById('productPrice').value;
  const stock = document.getElementById('productStock').value;
  const imageFile = document.getElementById('productImage').files[0];
  
  if (!name || !price || !categoryId) {
    alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: –Ω–∞–∑–≤–∞–Ω–∏–µ, —Ü–µ–Ω–∞ –∏ —Ä–∞–∑–¥–µ–ª');
    return;
  }
  
  const formData = new FormData();
  formData.append('category_id', categoryId);
  formData.append('name', name);
  formData.append('description', description);
  formData.append('price', price);
  formData.append('stock', stock);
  
  if (imageFile) {
    formData.append('image', imageFile);
  }
  
  try {
    const response = await fetch('/api/admin/products', {
      method: 'POST',
      body: formData
    });
    
    if (response.ok) {
      alert('–¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω');
      document.getElementById('adminProductForm').style.display = 'none';
      loadAdminProducts();
    } else {
      const errorText = await response.text();
      throw new Error(errorText || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
    }
  } catch (error) {
    console.error('Error saving product:', error);
    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞: ' + error.message);
  }
}

// –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
function adminEditProduct() {
  const productId = document.getElementById('adminProductSelect').value;
  if (!productId) {
    alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä');
    return;
  }
  
  const product = state.adminProducts.find(p => p.id == productId);
  if (!product) {
    alert('–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω');
    return;
  }
  
  const form = document.getElementById('adminProductForm');
  form.style.display = 'block';
  document.getElementById('productFormTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞';
  document.getElementById('productName').value = product.name;
  document.getElementById('productDescription').value = product.description || '';
  document.getElementById('productPrice').value = product.price;
  document.getElementById('productStock').value = product.stock || '';
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
async function adminUpdateProduct(productId) {
  const name = document.getElementById('productName').value;
  const description = document.getElementById('productDescription').value;
  const price = document.getElementById('productPrice').value;
  const stock = document.getElementById('productStock').value;
  const imageFile = document.getElementById('productImage').files[0];
  
  if (!name || !price) {
    alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Ü–µ–Ω–∞');
    return;
  }
  
  const formData = new FormData();
  formData.append('category_id', document.getElementById('adminCategorySelect').value);
  formData.append('name', name);
  formData.append('description', description);
  formData.append('price', price);
  formData.append('stock', stock);
  
  if (imageFile) {
    formData.append('image', imageFile);
  }
  
  try {
    const response = await fetch('/api/admin/products/' + productId, {
      method: 'PUT',
      body: formData
    });
    
    if (response.ok) {
      alert('–¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω');
      document.getElementById('adminProductForm').style.display = 'none';
      loadAdminProducts();
    } else {
      const errorText = await response.text();
      throw new Error(errorText || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
    }
  } catch (error) {
    console.error('Error updating product:', error);
    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞: ' + error.message);
  }
}

// –£–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
async function adminDeleteProduct() {
  const productId = document.getElementById('adminProductSelect').value;
  if (!productId) {
    alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä');
    return;
  }
  
  if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä?')) {
    return;
  }
  
  try {
    const response = await fetch('/api/admin/products/' + productId, {
      method: 'DELETE'
    });
    
    if (response.ok) {
      alert('–¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω');
      loadAdminProducts();
    } else {
      const errorText = await response.text();
      throw new Error(errorText || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
    }
  } catch (error) {
    console.error('Error deleting product:', error);
    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞: ' + error.message);
  }
}

// –°–æ–∑–¥–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞
function adminCreateCategory() {
  const form = document.getElementById('adminCategoryForm');
  form.style.display = 'block';
  document.getElementById('categoryFormTitle').textContent = '–°–æ–∑–¥–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞';
  document.getElementById('categoryName').value = '';
  document.getElementById('categoryDescription').value = '';
  document.getElementById('categoryPosition').value = '0';
  document.getElementById('categoryImage').value = '';
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞
async function adminSaveCategory() {
  const name = document.getElementById('categoryName').value;
  const description = document.getElementById('categoryDescription').value;
  const position = document.getElementById('categoryPosition').value;
  const imageFile = document.getElementById('categoryImage').files[0];
  
  if (!name) {
    alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ: –Ω–∞–∑–≤–∞–Ω–∏–µ');
    return;
  }
  
  const formData = new FormData();
  formData.append('name', name);
  formData.append('description', description);
  formData.append('position', position);
  
  if (imageFile) {
    formData.append('image', imageFile);
  }
  
  try {
    const response = await fetch('/api/admin/categories', {
      method: 'POST',
      body: formData
    });
    
    if (response.ok) {
      alert('–†–∞–∑–¥–µ–ª —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω');
      document.getElementById('adminCategoryForm').style.display = 'none';
      loadAdminCategories();
    } else {
      const errorText = await response.text();
      throw new Error(errorText || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
    }
  } catch (error) {
    console.error('Error saving category:', error);
    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ä–∞–∑–¥–µ–ª–∞: ' + error.message);
  }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –∞–∫—Ü–∏–π
async function loadAdminPromotions() {
  try {
    state.adminPromotions = await fetchJSON('/api/admin/promotions');
    const promotionsList = document.getElementById('adminPromotionsList');
    
    promotionsList.innerHTML = state.adminPromotions.length > 0 ? state.adminPromotions.map(p => `
      <div class="admin-list-item">
        <div style="display:flex; justify-content:space-between;">
          <strong>${p.title}</strong>
          <span>${p.active ? '‚úÖ –ê–∫—Ç–∏–≤–Ω–∞' : '‚ùå –ù–µ–∞–∫—Ç–∏–≤–Ω–∞'}</span>
        </div>
        <div>${p.content}</div>
        ${p.image_url ? `<img src="${p.image_url}" style="max-width:200px; max-height:200px; margin-top:10px;">` : ''}
        <div style="margin-top:10px;">
          <button onclick="adminEditPromotion(${p.id})">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
          <button onclick="adminDeletePromotion(${p.id})">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
      </div>
    `).join('') : '<div>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–∫—Ü–∏–π</div>';
  } catch (error) {
    console.error('Error loading promotions:', error);
    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫—Ü–∏–π');
  }
}

// –°–æ–∑–¥–∞–Ω–∏–µ –∞–∫—Ü–∏–∏
function adminCreatePromotion() {
  const form = document.getElementById('adminPromotionForm');
  form.style.display = 'block';
  document.getElementById('promotionFormTitle').textContent = '–°–æ–∑–¥–∞–Ω–∏–µ –∞–∫—Ü–∏–∏';
  document.getElementById('promotionTitle').value = '';
  document.getElementById('promotionContent').value = '';
  document.getElementById('promotionImage').value = '';
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞–∫—Ü–∏–∏
async function adminSavePromotion() {
  const title = document.getElementById('promotionTitle').value;
  const content = document.getElementById('promotionContent').value;
  const imageFile = document.getElementById('promotionImage').files[0];
  
  if (!title || !content) {
    alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ');
    return;
  }
  
  const formData = new FormData();
  formData.append('title', title);
  formData.append('content', content);
  
  if (imageFile) {
    formData.append('image', imageFile);
  }
  
  try {
    const response = await fetch('/api/admin/promotions', {
      method: 'POST',
      body: formData
    });
    
    if (response.ok) {
      alert('–ê–∫—Ü–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞');
      document.getElementById('adminPromotionForm').style.display = 'none';
      loadAdminPromotions();
    } else {
      const errorText = await response.text();
      throw new Error(errorText || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
    }
  } catch (error) {
    console.error('Error saving promotion:', error);
    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∞–∫—Ü–∏–∏: ' + error.message);
  }
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
window.addEventListener('click', (e) => {
  const t = e.target.closest('[data-tab]');
  if (!t) return;
  state.tab = t.dataset.tab;
  render();
});

document.getElementById('adminButton').addEventListener('click', showAdminModal);

// –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –≥–ª–æ–±–∞–ª—å–Ω—ã–º–∏ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
window.toggleFav = toggleFav;
window.viewProduct = viewProduct;
window.addToCart = addToCart;
window.decQty = decQty;
window.incQty = incQty;
  // –ü–æ–¥–∫–ª—é—á–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –º–∞–≥–∏—á–µ—Å–∫–∏–π —Å–∫—Ä–∏–ø—Ç
  </script>
  <script src="/static/js/tma-init.js"></script>
  <script src="/static/js/magical-app.js"></script>
window.adminCreateCategory = adminCreateCategory;
window.adminSaveCategory = adminSaveCategory;
window.loadAdminPromotions = loadAdminPromotions;
window.adminCreatePromotion = adminCreatePromotion;
window.adminSavePromotion = adminSavePromotion;

async function init() {
  try {
    if (window.Telegram && Telegram.WebApp) {
      Telegram.WebApp.ready();
    }
    await checkAdmin();
    await loadCategories();
    render();
  } catch (error) {
    console.error('Initialization error:', error);
  }
}

init();
</script>
</body>
</html>