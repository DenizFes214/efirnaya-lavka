import { Telegraf } from 'telegraf';
import dotenv from 'dotenv';
dotenv.config();

// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–æ—Ç–∞ –≠—Ñ–∏—Ä–Ω–æ–π –õ–∞–≤–∫–∏
const BOT_TOKEN = process.env.BOT_TOKEN || '8340741653:AAGFC-nW1BnLobjhgXSKRjNY83HkU4pCqrw';
const PUBLIC_URL = process.env.PUBLIC_URL || 'https://your-domain.amvera.io';

// –°–æ–∑–¥–∞—ë–º —ç–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞
const bot = new Telegraf(BOT_TOKEN);

// –ü—Ä–∏ –∫–æ–º–∞–Ω–¥–µ /start –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –º–∞–≥–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
bot.start((ctx) => {
    const userName = ctx.from.first_name || '–ü—É—Ç–µ—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫';
    
    ctx.reply(`üåü –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é —Ç–µ–±—è, ${userName}, –≤ üåø *–≠—Ñ–∏—Ä–Ω–æ–π –õ–∞–≤–∫–µ* üåø
    
üïØÔ∏è –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –º–∏—Ä –¥—Ä–µ–≤–Ω–µ–π –º—É–¥—Ä–æ—Å—Ç–∏ –∏ –º–∞–≥–∏—á–µ—Å–∫–∏—Ö –∞—Ä–æ–º–∞—Ç–æ–≤!

–ó–¥–µ—Å—å —Ç—ã –Ω–∞–π–¥–µ—à—å:
ÔøΩ –†–µ–¥—á–∞–π—à–∏–µ —ç—Ñ–∏—Ä–Ω—ã–µ –º–∞—Å–ª–∞
üçÉ –°–≤—è—â–µ–Ω–Ω—ã–µ —Ç—Ä–∞–≤—ã –∏ —Å–±–æ—Ä—ã  
üîÆ –†–∏—Ç—É–∞–ª—å–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã —Å–∏–ª—ã
üìú –î—Ä–µ–≤–Ω–∏–µ –∑–Ω–∞–Ω–∏—è –∏ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞
‚ú® –ú–∞–≥–∏—á–µ—Å–∫–∏–µ —É—Å–ª—É–≥–∏ –∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏

–û—Ç–∫—Ä–æ–π –≤—Ä–∞—Ç–∞ –≤ –Ω–∞—à –º–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –º–∞–≥–∞–∑–∏–Ω...`, {
        parse_mode: 'Markdown',
        reply_markup: {
            keyboard: [
                [
                    {
                        text: 'üåø –í–æ–π—Ç–∏ –≤ –≠—Ñ–∏—Ä–Ω—É—é –õ–∞–≤–∫—É ‚ú®',
                        web_app: { url: PUBLIC_URL }
                    }
                ],
                [
                    { text: 'üìã –ú–æ–∏ –∑–∞–∫–∞–∑—ã' },
                    { text: 'üí¨ –ü–æ–¥–¥–µ—Ä–∂–∫–∞' }
                ]
            ],
            resize_keyboard: true
        }
    });
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã "–ú–æ–∏ –∑–∞–∫–∞–∑—ã"
bot.hears('üìã –ú–æ–∏ –∑–∞–∫–∞–∑—ã', (ctx) => {
    ctx.reply('üîÆ –í–∞—à–∏ –∑–∞–∫–∞–∑—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑ –º–∞–≥–∏—á–µ—Å–∫–∏—Ö –∑–∞–ø–∏—Å–µ–π...', {
        reply_markup: {
            inline_keyboard: [
                [{ text: 'üåø –û—Ç–∫—Ä—ã—Ç—å –ª–∞–≤–∫—É', web_app: { url: `${PUBLIC_URL}/orders` } }]
            ]
        }
    });
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã "–ü–æ–¥–¥–µ—Ä–∂–∫–∞"
bot.hears('üí¨ –ü–æ–¥–¥–µ—Ä–∂–∫–∞', (ctx) => {
    ctx.reply(`üßô‚Äç‚ôÄÔ∏è –°–ª—É–∂–∏—Ç–µ–ª–∏ –≠—Ñ–∏—Ä–Ω–æ–π –õ–∞–≤–∫–∏ –≤—Å–µ–≥–¥–∞ –≥–æ—Ç–æ–≤—ã –ø–æ–º–æ—á—å!

üìû –î–ª—è —Å–≤—è–∑–∏ —Å –Ω–∞—à–∏–º–∏ –º–∞–≥–∞–º–∏:
‚Ä¢ @DaryaDub_07 - –î–∞—Ä—å—è, –º–∞—Å—Ç–µ—Ä —Ç—Ä–∞–≤ –∏ –º–∞—Å–µ–ª
‚Ä¢ @Dan_vark - –ê–ª–µ–∫—Å–µ–π, –∑–Ω–∞—Ç–æ–∫ —Ä–∏—Ç—É–∞–ª—å–Ω—ã—Ö –ø—Ä–∞–∫—Ç–∏–∫

üìß –ò–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ —Å—é–¥–∞ —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å, –∏ –º—ã –æ—Ç–≤–µ—Ç–∏–º –≤ —Ç–µ—á–µ–Ω–∏–µ –¥–Ω—è.

‚ú® –î–∞ –ø—Ä–µ–±—É–¥–µ—Ç —Å –≤–∞–º–∏ –º–∞–≥–∏—è!`);
});

// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∑–∞–ø—É—Å–∫ –¥–ª—è server.js
export function initBot(app) {
    // –ü–æ–¥–∫–ª—é—á–∞–µ–º webhook
    app.use(bot.webhookCallback('/telegram/webhook'));

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º webhook
    bot.telegram.setWebhook(`${PUBLIC_URL}/telegram/webhook`)
        .then(() => console.log('üåø Webhook —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–ª—è –≠—Ñ–∏—Ä–Ω–æ–π –õ–∞–≤–∫–∏:', `${PUBLIC_URL}/telegram/webhook`))
        .catch(console.error);
    
    console.log('üîÆ –ë–æ—Ç –≠—Ñ–∏—Ä–Ω–æ–π –õ–∞–≤–∫–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ –∫–∞–Ω–∞–ª—ã
export async function sendChannelNotification(message, isTest = false) {
    try {
        const channelId = isTest ? '-1002277761715' : '-1002261187486';
        await bot.telegram.sendMessage(channelId, message, { parse_mode: 'Markdown' });
        return true;
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –∫–∞–Ω–∞–ª:', error);
        return false;
    }
}
